<div id=D__ID>
	<div class="container mt-95 mb-3">
    	<div class="row" >
			<div class="col-12 col-lg-7 col-md-11 col-sm-12 mx-auto formbox">
        		<div class="row">
            		<div class="col-12">
						<form id=F__ID>
							<h3 class="text-center"><label id="label_status__ID" class="text-white"></label> Project Details </h3>
							<div class="form-group">
								<div class="questiongroup ">
		                           <fieldset>
		                                <label style="width:100%" class=""><span class="">Project Name</span>
											<input class="form-control" name="Project" type="text" >
											<input class="form-control" name="PUID" type="text" style="display:none" >
		                                </label>
		                           </fieldset>
                      			</div>
					  			<div class="questiongroup ">
									<fieldset class="subquestions">
                                		<label class=""><span class="">Code</span>
											<input class="form-control" name="Project_Code" id="Project_Code__ID" type="text" >
                                		</label><br>
                                		<label class=""><span class="">Country</span>
											<input class="form-control" name="Country" type="text" readonly >
                                		</label><br>
                           			</fieldset>
                          		</div>
								<div class="questiongroup ">
		                           <fieldset>
		                                <label style="width:100%" class=""><span class="">Description</span>
											<textarea class="form-control form-control-sm" name="Description"></textarea>
		                                </label>
		                           </fieldset>
                      			</div>
								<div class="questiongroup ">
		                           <fieldset>
		                                <label style="width:100%" class=""><span class="">Theme</span>
											<input class="form-control" name="Theme" id="Theme__ID" type="text" >
		                                </label>
		                           </fieldset>
                      			</div>
								<div class="questiongroup ">
		                           <fieldset>
		                                <label style="width:100%" class=""><span class="">Primary Sector</span>
											<input class="form-control" name="Sector" id="Sector__ID" type="text" >
		                                </label>
		                           </fieldset>
                      			</div>
								<div class="questiongroup ">
		                           <fieldset>
		                                <label style="width:100%" class=""><span class="">Secondary Sector</span>
											<input class="form-control" name="Secondary_Sector" id="Secondary_Sector__ID" type="text" >
		                                </label>
		                           </fieldset>
                      			</div>
								<div class="questiongroup ">
		                           <fieldset>
		                                <label style="width:100%" class=""><span class="">Implementation Arrangement</span>
											<input class="form-control" name="Implementation_Arrangement" id="Implementation_Arrangement__ID" type="text" >
		                                </label>
		                           </fieldset>
                      			</div>
								<div class="questiongroup ">
		                           <fieldset>
		                                <label style="width:100%" class=""><span class="">DRR Mainstreaming</span>
											<input class="form-control" name="DRR_Mainstreaming" id="DRR_Mainstreaming__ID" type="text" >
		                                </label>
		                           </fieldset>
                      			</div>
								<div class="questiongroup ">
									<fieldset class="subquestions">
                                		<label class=""><span class="">Start</span>
											<input class="form-control" name="Start" type="text" id=Start__ID >
                                		</label><br>
                                		<label class=""><span class="">End</span>
											<input class="form-control" name="End" type="text"  id=End__ID>
                                		</label><br>
										<label class=""><span class="">Status</span>
											<select class="form-control" name="Project_Status" id=Project_Status__ID ><option value=""></option><option value="Open">Open</option><option value="Closed">Closed</option></select>
                                		</label><br>
                           			</fieldset>
                          		</div>
								<div class="questiongroup ">
									<fieldset class="subquestions">
                                		<label style="width:100%" ><span class="">Location 1</span>
											<input class="form-control" name="Location" type="text" id=Location__ID >
                                		</label>
									</fieldset>
								</div>
								<div class="questiongroup ">
									<fieldset class="subquestions">
                                		<label  style="width:100%"><span class="">Location 2</span>
											<input class="form-control" name="Location_2" type="text"  id=Location_2__ID>
                                		</label>
                           			</fieldset>
                          		</div>
								<div class="questiongroup ">
									<fieldset class="subquestions">
                                		<label  style="width:100%"><span class="">Location 3</span>
											<input class="form-control" name="Location_3" type="text" id=Location_3__ID >
                                		</label>
									</fieldset>
								</div>
								<div class="questiongroup ">
									<fieldset class="subquestions">
                                		<label  style="width:100%"><span class="">Location 4</span>
											<input class="form-control" name="Location_4" type="text"  id=Location_4__ID>
                                		</label>
                           			</fieldset>
                          		</div>
								<div class="questiongroup ">
									<fieldset class="subquestions">
                                		<label class=""><span class="">Approval Status</span>
											<input class="form-control" name="Approval_Status" type="text" id=Approval_Status__ID >
                                		</label><br>
                                		<label class=""><span class="">Approval Date</span>
											<input class="form-control" name="Approval_Date" type="text"  id=Approval_Date__ID>
                                		</label><br>
                           			</fieldset>
                          		</div>
								<div class="questiongroup ">
		                           <fieldset>
		                                <label style="width:100%" class=""><span class="">List of people to be updated</span>
											<textarea class="form-control form-control-sm" name="List_people_updated" placeholder="Enter your name here to receive updates of this project" ></textarea>
		                                </label>
		                           </fieldset>
                      			</div>
								<div class="questiongroup ">
		                           <fieldset>
		                                <label style="width:100%" class=""><span class="">Comments</span>
											<textarea class="form-control form-control-sm" name="New_Comments" id=New_Comments__ID placeholder="Enter Comments here" ></textarea>
		                                </label>
		                           </fieldset>
                      			</div>
								<div class="questiongroup ">
		                           <fieldset>
		                                <label style="width:100%" class=""><span class="">Comments History</span>
											<textarea class="form-control form-control-sm" name="Comments" id=Comments__ID placeholder="" ></textarea>
		                                </label>
		                           </fieldset>
                      			</div>
								<div class="questiongroup ">
									<fieldset class="subquestions">
                                		<label class=""><span class="">Creation Date</span>
											<input class="form-control" name="Creation_Date" type="text" id=Creation_Date__ID >
                                		</label><br>
                                		<label class=""><span class="">Created By</span>
											<input class="form-control" name="Created_By" type="text"  id=Created_By__ID>
                                		</label><br>
                           			</fieldset>
                          		</div>
								<div class="questiongroup ">
									<fieldset class="subquestions">
										<label class="checkboxes">Additional funds requested
										  <input type="checkbox" name="Request_Fund" id="Request_Fund__ID" >
										  <span class="check_checkmark"></span>
									    </label>
									</fieldset>
                          		</div>
								<div class="questiongroup ">
									<fieldset class="subquestions">
										<label style="width:100%" class=""><span class="">Requested amount &amp; FY(s)</span>
										  <textarea class="form-control form-control-sm" name="Requested_amount" placeholder=""></textarea>
									    </label>
									</fieldset>
                      			</div>
								<div class="row">
									<div class=col>
										<button id=submit__ID type="submit" class="btn btn-secondary">Submit</button>
									</div>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
<script>
    function F__ID(){
		//-------------------------------------
		VmInclude:__COMPONENT__/module/form.v1.js
		VmInclude:__CURRENT_PATH__/task_form.js
		//-------------------------------------
		
		
		m.xml=1;
		//-------------------------------------
		var project_uid=0;
		var project_status="";
		var project_code="";
		var approval_status="";
		var request_fund=false;
		//-------------------------------------
		//m.default_load=m.load;
		m.load=function(){
			//project_uid=$vm.vm.proj_uid;
			m.set_req();
			m.request_data();
			//m.default_load();
			//Replace old html code
		}
		//-------------------------------------
		m.set_req=function(){
			var sql="select Information,B1,ID,UID,PUID from [TABLE-"+m.db_pid+"] where UID=@I1 ";
			m.req={cmd:'read',db_pid:m.db_pid,sql:sql,i1:$vm.vm.proj_uid}
		}
		//-------------------------------------
		m.request_data=function(){
		    if(m.req==='') return;
		    var mt1=new Date().getTime();
			$('#vm_loader').show();
		    $VmAPI.request({data:m.req,callback:function(res){
				$('#vm_loader').hide();
		        m.form_I=-1;
		        m.records=res.records;
				$('#F__ID')[0].reset();
			    $('#submit__ID').show();
			    var grid_record=m.records[0];
				$vm.deserialize(grid_record,'#F__ID');
				$('#Comments__ID').val($('#Comments__ID').val().replace(/<span class=C20000012_light_small>/g,'').replace(/<\/span>/g,'').replace(/<br>/g,'\n'));
				project_status=$('#Project_Status__ID').val();
				project_code=$('#Project_Code__ID').val();
				approval_status=$('#Approval_Status__ID').val();
				request_fund=$('#Request_Fund__ID').is(':checked');
				$('#label_status__ID').html(project_status)
		    }})
		}
		//-------------------------------------
		$('#Start__ID').datepicker({dateFormat:'M yy',changeMonth:true,changeYear:true, autoclose: true});
		$('#End__ID').datepicker({dateFormat:'M yy',changeMonth:true,changeYear:true, autoclose: true});
		$('#Approval_Date__ID').datepicker({dateFormat:'dd/mm/yy', autoclose: true});
		$('#Creation_Date__ID').datepicker({dateFormat:'dd/mm/yy', autoclose: true});
		//-------------------------------------
		var sql="with tb as (select name=@('Sector'),value2=uid from [TABLE-"+$vm.module_list['sector-data'].table_id+"])";
		sql+=" select top 10 name,value=name,value2 from tb where Name like '%'+@S1+'%' ";
		$vm.autocomplete($('#Secondary_Sector__ID'),sql,function(key,value){
			$("#F__ID input[name="+key+"]").val($vm.text(value));
		})
		$vm.autocomplete($('#Sector__ID'),sql,function(key,value){
			$("#F__ID input[name="+key+"]").val($vm.text(value));
		})
		sql="with tb as (select name=@('Implementation_Arrangement'),value2=uid from [TABLE-"+$vm.module_list['implementation-arrangement-data'].table_id+"])";
		sql+=" select top 10 name,value=name,value2 from tb where Name like '%'+@S1+'%' ";
		$vm.autocomplete($('#Implementation_Arrangement__ID'),sql,function(key,value){
			$("#F__ID input[name="+key+"]").val($vm.text(value));
		})
		sql="with tb as (select name=@('DRR_Mainstreaming'),value2=uid from [TABLE-"+$vm.module_list['drr-mainstreaming-data'].table_id+"])";
		sql+=" select top 10 name,value=name,value2 from tb where Name like '%'+@S1+'%' ";
		$vm.autocomplete($('#DRR_Mainstreaming__ID'),sql,function(key,value){
			$("#F__ID input[name="+key+"]").val($vm.text(value));
		})
		sql="with tb as (select name=@('Theme'),value2=uid from [TABLE-"+$vm.module_list['theme-data'].table_id+"])";
		sql+=" select top 10 name,value=name,value2 from tb where Name like '%'+@S1+'%' ";
		$vm.autocomplete($('#Theme__ID'),sql,function(key,value){
			$("#F__ID input[name="+key+"]").val($vm.text(value));
		})
		sql="with tb as (select name=@('Location'),value2=uid from [TABLE-"+$vm.module_list['location-data'].table_id+"])";
		sql+=" select top 10 name,value=name,value2 from tb where Name like '%'+@S1+'%' ";
		$vm.autocomplete($('#Location__ID'),sql,function(key,value){
			$("#F__ID input[name="+key+"]").val($vm.text(value));
		})
		$vm.autocomplete($('#Location_2__ID'),sql,function(key,value){
			$("#F__ID input[name="+key+"]").val($vm.text(value));
		})
		$vm.autocomplete($('#Location_3__ID'),sql,function(key,value){
			$("#F__ID input[name="+key+"]").val($vm.text(value));
		})
		$vm.autocomplete($('#Location_4__ID'),sql,function(key,value){
			$("#F__ID input[name="+key+"]").val($vm.text(value));
		})
		sql="with tb as (select name=@('Approval_Status'),value2=uid from [TABLE-"+$vm.module_list['project-approval-status-data'].table_id+"])";
		sql+=" select top 10 name,value=name,value2 from tb where Name like '%'+@S1+'%' ";
		$vm.autocomplete_split($('#Approval_Status__ID'),sql,function(key,value){
			$("#F__ID input[name=Approval_Status]").val($vm.text(value));
		})
		sql="with tb as (select name=@('Code'),value3=@('Program'),value4=@('Country'),value2=uid from [TABLE-"+$vm.module_list[m.prefix+'program-form'].table_id+"])";
		sql+=" select top 10 name,value=name,value2,value3,value4 from tb where Name like '%'+@S1+'%' ";
		$vm.autocomplete($('#Code__ID'),sql,function(key,value,value3,value4){
			$("#F__ID input[name=PUID]").val($vm.text(value));
			$("#F__ID input[name=I2_Program]").val($vm.text(value3));
			$("#F__ID input[name=Country]").val($vm.text(value4));
		})
	$('#New_Comments__ID').change(function(){
			process_comments();
		});
		$('#Project_Status__ID').change(function(){
			if(project_status=="Open" && ($vm.user!="jojo" && $vm.user!="childfund")){
				alert("Only Administrator can Close the Project!");
				$('#Project_Status__ID').val("Open");
			}
		});
		$('#Project_Code__ID').change(function(){
			if(project_code!=$('#Project_Code__ID').val() && project_code!==''){
				if($vm.user!="jojo" && $vm.user!="childfund"){
					alert("Only Administrator can change Project Code!");
					$('#Project_Code__ID').val(project_code);
				}
			}
		});
		var app_stat=function(){
			if(approval_status!=$('#Approval_Status__ID').val() && approval_status=='PA'){
				if($vm.user!="jojo" && $vm.user!="childfund"){
					alert("Only Administrator can change Approval Status when approved!");
					$('#Approval_Status__ID').val("PA")
				}
			}
		};
		//-------------------------------------
		var get_now=function(){
            var today = new Date();
            var dd = today.getDate();
            var mm = today.getMonth()+1; //January is 0!
            var yyyy = today.getFullYear();
            var hh = today.getHours();
            var min = today.getMinutes();
            if(dd<10) dd='0'+dd;
            if(mm<10) mm='0'+mm;
            if(hh<10) hh='0'+hh;
            if(min<10) min='0'+min;
            return dd+'/'+mm+'/'+yyyy+' '+hh+':'+min;
        }
		//-------------------------------------
        var process_comments=function(){
    		if($('#New_Comments__ID').val()!==""){
    			var old_comments="";
    			if($('#Comments__ID').val()!=="") old_comments=$('#Comments__ID').val();
    			var new_comments="("+get_now()+", "+$vm.user+")\n"+$('#New_Comments__ID').val()+"\n";
    			$('#Comments__ID').val(new_comments+old_comments);
    			$('#New_Comments__ID').val('');
    		}
    	}
		//-------------------------------------
		m.before_submit=function(data,dbv){
			if(data.PUID!=='') dbv.PUID=data.PUID;
            dbv.PPID=$vm.module_list[m.prefix+'program-data'].table_id;
            return true;
		}
		//-------------------------------------
		m.after_add=function(record,dbv,res){
			alert("Send Email for a new Project");
			if($('#Approval_Status__ID').val()!=approval_status && $('#Approval_Status__ID').val()=='PA') {
				alert("Send Email for Project Approval")
			}
			if($('#Request_Fund__ID').is(':checked')!=request_fund && $('#Request_Fund__ID').is(':checked')==true) {
				alert("Send Email for Requested Fund")
			}
			$vm.refresh=1;
            window.history.go(-1);                       //modify
		}
		//-------------------------------------
		m.after_modify=function(record,dbv,res){
			if($('#Approval_Status__ID').val()!=approval_status && $('#Approval_Status__ID').val()=='PA') {
				alert("Send Email for Project Approval")
			}
			if($('#Request_Fund__ID').is(':checked')!=request_fund && $('#Request_Fund__ID').is(':checked')==true) {
				alert("Send Email for Requested Fund")
			}
			$vm.refresh=1;
            window.history.go(-1);                       //modify
		}
    }
</script>
<style>
#D__ID{
  height:100%;
  animation: vm_module_fadein 1.0s;
  overflow: auto;
}
</style>
VmInclude:__CURRENT_PATH__/task-form.css
</div>
